<% title "Expenses" %>
<span id="show_options"></span>

<div id="tabs">
  <ul class="nav nav-tabs">
    <li><a href="#tabular" data-toggle="tab"><%= I18n.t 'table' %></a></li>
    <li><a href="#charts1" data-toggle="tab"><%= I18n.t 'budget expenses categories' %></a></li>
    <li><a href="#charts2" data-toggle="tab"><%= I18n.t 'all expenses categories' %></a></li>
    <li><a href="#charts3" data-toggle="tab"><%= I18n.t 'show options' %></a></li>
  </ul>
</div>

<div class="tab-content">
  <div class="tab-pane active" id="tabular">
    <table id="expensesTable" class="table table-striped table-hover table-condensed">
      <thead>
        <tr>
          <th><%= I18n.t 'id' %></th>
          <th></th>
          <th><%= I18n.t 'description' %></th>
          <th class="amount"><%= I18n.t 'value' %></th>
          <th><%= I18n.t 'expense date' %></th>
          <th><%= I18n.t 'tags' %></th>
          <th></th>
        </tr>
      </thead>
    <%
    sum = 0;
    id = 0;
    @expenses.each do |expense|
      # sum += expense.amount
      id += 1
      %>
      <%
      tags = []
      budgetIncluded = false
      expense.expenses_tags_association.each do |tag_id|
        if tag_id.tag.budget
          budgetIncluded = true
        end
        tags.push(link_to tag_id.tag.name, tag_id.tag, {:target => '_blank'}) %>
      <% end %>
      <tr>
        <td><%= id %></td>
        <td>
          <% if budgetIncluded %>
            <i class="icon-asterisk" title="<%= I18n.t 'included in budget' %>"></i>
          <% end %>
          <% if expense.half == 1 %>
            <i class="icon-star-empty" title="<%= I18n.t 'half of amount' %>"></i>
          <% end %>
        </td>
        <td><%= link_to expense.description, '#edit_expense_modal', {"data-toggle"=>"modal", "data-remote"=> edit_expense_path(expense) } %></td>
        <td class="amount">
          <% if expense.half == 1 %>
            <%= number_to_currency expense.amount / 2 %>
          <% else %>
            <%= number_to_currency expense.amount %>
          <% end %>
        </td>
        <td><%= expense.date %></td>
        <td>
          <%= tags.to_sentence.html_safe %>
        </td>
        <td>
          <%= link_to '<i class="icon-edit"></i>'.html_safe, '#edit_expense_modal', {:title => (I18n.t 'edit'), "data-toggle"=>"modal", "data-remote"=> edit_expense_path(expense) }  %>
          <%= link_to '<i class="icon-trash"></i>'.html_safe, expense, method: :delete, data: { confirm: (I18n.t 'Are you sure?') }, :title => (I18n.t 'delete') %>
        </td>
      </tr>
    <% end %>
      <tfoot>
        <tr>
          <td></td>
          <td></td>
          <td><%= I18n.t 'sum' %>:</td>
          <td id="sum"><%= number_to_currency @expenses_sum %></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>
  <div class="tab-pane" id="charts1">
    <div id="pieChart2" class="chart"></div>
  </div>
  <div class="tab-pane" id="charts2">
    <div id="pieChart" class="chart"></div>
  </div>
    <div class="tab-pane" id="charts3">
      <div class="row">
        <%= render 'budgets_form' %>
        <%= render 'tags_form' %>
      </div>
    </div>
</div>

<div class="modal fade" id="edit_expense_modal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title"><%= I18n.t 'edit expense' %></h4>
      </div>
      <div class="modal-body">
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  jQuery('#tabs a').click(function (e) {
    e.preventDefault();
    jQuery(this).tab('show');
  })

  jQuery(document).ready(function(){
    jQuery('#budget').change(function(){
      jQuery('#formBudget').submit();
    })

    jQuery('#expensesTable').dataTable({
      "fnFooterCallback": function ( nRow, aaData, iStart, iEnd, aiDisplay ) {

            var expenses_sum = 0;
            for ( var i=0 ; i<aiDisplay.length ; i++ )
            {
                Globalize.culture("pl");
                amount = Globalize.parseFloat(Globalize.format(aaData[aiDisplay[i]][3], "c"));
                expenses_sum += Number(amount);
            }
            
            jQuery("#sum").html(Globalize.format(expenses_sum, "c"));
        }
    });
    
  });
</script>
<script type="text/javascript">
  jQuery(function () {
      var chart;
      jQuery(document).ready(function() {
          chart = new Highcharts.Chart({
              credits: false,
              chart: {
                  renderTo: 'pieChart',
                  plotBackgroundColor: null,
                  plotBorderWidth: null,
                  plotShadow: true
              },
              title: false,
              tooltip: {
                pointFormat: '<b>{point.y} zł ( {point.percentage}% )</b>',
                percentageDecimals: 1
              },
              plotOptions: {
                  pie: {
                      allowPointSelect: true,
                      cursor: 'pointer',
                      dataLabels: {
                          enabled: false
                      },
                      showInLegend: true
                      }
              },
              legend: {
                layout: 'horizontal',
                labelFormatter: function() {
                  return this.name;
                }
              },
              series: [{
                  type: 'pie',
                  name: 'share',
                  data: <%= @chart_data.to_json.html_safe %>
              }]
          });
          chart2 = new Highcharts.Chart({
              credits: false,
              chart: {
                  renderTo: 'pieChart2',
                  plotBackgroundColor: null,
                  plotBorderWidth: null,
                  plotShadow: true
              },
              title: false,
              tooltip: {
                // pointFormat: '{series.name}: <b>{point.percentage}%</b>',
                pointFormat: '<b>{point.y} zł ( {point.percentage}% )</b>',
                percentageDecimals: 1
              },
              plotOptions: {
                  pie: {
                      allowPointSelect: true,
                      cursor: 'pointer',
                      dataLabels: {
                          enabled: false
                      },
                      showInLegend: true
                  }
              },
              legend: {
                layout: 'horizontal',
                labelFormatter: function() {
                  // return '<b>'+ this.name +'</b>( '+ this.y.toFixed(2) +' zł )';
                  return this.name;
                }
              },
              series: [{
                  type: 'pie',
                  name: 'share',
                  data: <%= @chart_data2.to_json.html_safe %>
              }]
          });
      });

});
</script>